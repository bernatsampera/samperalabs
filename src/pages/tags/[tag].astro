---
import Layout from '../../layouts/PageLayout.astro';
import {getDB} from '../../lib/db';
import PostCard from '~/components/common/PostCard.astro';

// Generate static paths for all tags
export async function getStaticPaths() {
  const db = getDB();
  const allPosts = db.getAllPosts();

  // Get all unique tags
  const allTags = [...new Set(allPosts.flatMap((post) => post.tags))];

  return allTags.map((tag) => ({
    params: {tag},
  }));
}

// Get the tag from the URL params
const {tag} = Astro.params;

if (!tag) {
  return Astro.redirect('/404');
}

// Fetch posts with this tag from the database
const db = getDB();
const posts = db.getPostsByTag(tag);

const metadata = {
  title: `Posts tagged with ${tag}`,
};
---

<Layout metadata={metadata}>
  <div class="min-h-screen bg-background">
    <!-- Navigation -->
    <nav class="border-b">
      <div class="container mx-auto px-6 py-6 max-w-4xl">
        <a href="/blog" class="text-muted-foreground hover:text-foreground transition-colors"> ‚Üê Back to blog </a>
      </div>
    </nav>

    <!-- Tag Header -->
    <header class="container mx-auto px-6 py-16 max-w-4xl">
      <h1 class="text-4xl md:text-6xl font-bold text-foreground mb-4">
        {tag}
      </h1>
      <p class="text-lg text-muted-foreground">
        Posts tagged with "{tag}"
      </p>
    </header>

    <!-- Posts -->
    <main class="container mx-auto px-6 pb-16 max-w-4xl">
      {
        posts.length === 0 ? (
          <div class="text-center py-16">
            <p class="text-muted-foreground text-lg">No posts found with this tag.</p>
          </div>
        ) : (
          <div class="space-y-16">
            {posts.map((post) => (
              <PostCard post={post} />
            ))}
          </div>
        )
      }
    </main>
  </div>
</Layout>
