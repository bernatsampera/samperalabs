---
import PageLayout from '../layouts/PageLayout.astro';
import {getDB} from '../lib/db';

// Get the selected tag from URL search params
const url = new URL(Astro.request.url);
const tag = url.searchParams.get('tag');

// Fetch posts from database instead of files
const db = getDB();
const allPosts = db.getAllPosts();

// Get all unique tags
const allTags = allPosts.map((post) => post.tags).flat();

// Filter posts by tag if one is selected
const postsToShow = tag ? db.getPostsByTag(tag) : allPosts;

// Group posts by year
const postsByYear = postsToShow.reduce((acc, post) => {
  const year = new Date(post.pub_date).getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof postsToShow>);


const tagCounts = allTags.reduce((count, tagName) => {
  count[tagName] = (count[tagName] || 0) + 1;

  console.log(tagName);
  return count;
}, {} as Record<string, number>);

// Sort years in descending order
const sortedYears = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);

const metadata = {
  title: tag ? `Posts tagged with ${tag} | Sampera Labs Blog` : 'Blog | Bernat Sampera',
  description: 'Sampera Labs Blog',
};
---

<PageLayout metadata={metadata}>
  <div class="min-h-screen bg-background">
    <!-- Blog Header -->
    <header class="border-b">
      <div class="container mx-auto px-6 py-12 max-w-4xl">
        <div class="flex items-center justify-between mb-6">


        </div>


        <!-- Tag Filter -->
        <div class="flex flex-wrap gap-2">
          <a
            href="/blog"
            class={`px-3 py-1 text-sm rounded-sm transition-colors ${
              !tag 
                ? 'bg-foreground underline' 
                : 'bg-muted text-muted-foreground hover:text-foreground'
            }`}
          >
            All posts
          </a>
          {
            Object.entries(tagCounts).sort((a, b) => b[1] - a[1]).map(([tagName, count]) => (
            <a
              href={`/blog?tag=${encodeURIComponent(tagName)}`}
              class={`px-3 py-1 text-sm rounded-sm transition-colors ${
                tag === tagName 
                  ? 'bg-foreground underline' 
                  : 'bg-muted text-muted-foreground hover:text-foreground'
              }`}
            >
              {tagName} ({count})
            </a>
          ))}
        </div>
      </div>
    </header>

    <!-- Blog Content -->
    <main class="container mx-auto px-6 py-16 max-w-4xl">
      <!-- Post Creation Button -->
      <div id="new-post-button" class="mb-12 hidden">
        <a
          href="/admin/new-post"
          class="inline-flex items-center px-6 py-3 bg-primary-foreground hover:bg-primary/90 transition-colors border rounded-sm font-medium"
        >
          New Post
        </a>
      </div>

      <!-- Posts by Year -->
      {
        postsToShow.length === 0 ? (
          <div class="text-center py-16">
            {tag ? (
              <div>
                <p class="text-muted-foreground text-lg mb-6">No posts found with tag "{tag}".</p>
                <a
                  href="/blog"
                  class="inline-flex items-center px-6 py-3 bg-muted hover:bg-muted/80 transition-colors border rounded-sm font-medium"
                >
                  View all posts
                </a>
              </div>
            ) : (
              <div>
                <p class="text-muted-foreground text-lg mb-6">No posts yet.</p>
                <a
                  id="first-post-button"
                  href="/admin/new-post"
                  class="inline-flex items-center px-8 py-4 bg-primary-foreground hover:bg-primary/90 transition-colors border  rounded-sm font-medium hidden"
                >
                  Write your first post
                </a>
              </div>
            )}
          </div>
        ) : (
          <div class="space-y-16">
            {sortedYears.map((year) => (
              <section>
                <h2 class="text-3xl font-bold text-foreground mb-8">{year}</h2>
                <div class="space-y-6">
                  {postsByYear[year].map((post) => (
                    <article class="group">
                      <a href={`/posts/${post.slug}`} class="flex items-center justify-start gap-8 hover:opacity-40 transition-opacity">
                      <div class="grid grid-cols-1 md:grid-cols-12 gap-1 md:gap-4">
                        <!-- Date -->
                        <time class="text-sm text-muted-foreground font-mono min-w-[80px]">
                          {
                            new Date(post.pub_date).toLocaleDateString('en-GB', {
                              day: '2-digit',
                              month: 'short',
                            })
                          }
                        </time>
                        
                        <div class="flex flex-col gap-2 col-span-8">
                        <!-- Title -->
                        <h3 class="relative text-sm md:text-lg font-medium text-foreground leading-relaxed">
                          {post.title}
                          <p class="absolute top-6 text-sm text-muted-foreground pointer-events-none cursor-default " >
                        </p>
                        </h3>
                       
                        </div>  

                        <p class="hidden md:block text-xs text-muted-foreground col-span-1">
                          {Math.max(Math.floor(post.content.length/1000), 1)} min read
                        </p>

                        <span class="hidden md:block text-sm text-muted-foreground col-span-2">
                          {post.tags.join(', ')}
                        </span>

                      </div>

                      </a>
                    </article>
                  ))}
                </div>
              </section>
            ))}
          </div>
        )
      }
    </main>
  </div>
</PageLayout>

<script>
  // Check if user is admin and show/hide admin actions
  const isAdmin = localStorage.getItem('isAdmin');
  const newPostButton = document.getElementById('new-post-button');
  const firstPostButton = document.getElementById('first-post-button');

  if (isAdmin === 'true') {
    newPostButton?.classList.remove('hidden');
    firstPostButton?.classList.remove('hidden');
  }
</script>
