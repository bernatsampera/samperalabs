---
import Button from '~/components/ui/Button.astro';
import Layout from '../../../layouts/PageLayout.astro';
import {getDB} from '../../../lib/db';

// Get the post ID from the URL params
const {id} = Astro.params;

// Fetch the post from the database
const db = getDB();
const post = db.getPostById(Number(id));

// If post not found, return 404
if (!post) {
  return Astro.redirect('/404');
}

const metadata = {
  title: `Edit: ${post.title}`,
};
---

<Layout metadata={metadata}>
  <div class="min-h-screen bg-background">
    <!-- Navigation -->
    <nav class="border-b">
      <div class="container mx-auto px-6 py-6 max-w-4xl">
        <a href={`/posts/${post.slug}`} class="text-muted-foreground hover:text-primary transition-colors">
          ← Back to post
        </a>
      </div>
    </nav>

    <!-- Form -->
    <main class="container mx-auto px-6 py-16 max-w-4xl">
      <div class="max-w-2xl">
        <h1 class="text-4xl md:text-6xl font-bold text-primary mb-12">Edit Post</h1>

        <form id="edit-post-form" class="space-y-8">
          <input type="hidden" id="post-id" value={post.id} />

          <!-- Title -->
          <div class="space-y-2">
            <label for="title" class="block text-sm font-medium text-primary"> Title* </label>
            <input
              type="text"
              id="title"
              name="title"
              required
              value={post.title}
              class="w-full px-4 py-3 border rounded-sm text-primary placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
            />
          </div>

          <!-- Author -->
          <div class="space-y-2">
            <label for="author" class="block text-sm font-medium text-primary"> Author* </label>
            <input
              type="text"
              id="author"
              name="author"
              required
              value={post.author}
              class="w-full px-4 py-3 border rounded-sm text-primary placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
            />
          </div>

          <!-- Description -->
          <div class="space-y-2">
            <label for="description" class="block text-sm font-medium text-primary"> Description </label>
            <textarea
              id="description"
              name="description"
              rows="3"
              class="w-full px-4 py-3 border rounded-sm text-primary placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring resize-none"
              >{post.description || ''}</textarea
            >
          </div>

          <!-- Publication Date -->
          <div class="space-y-2">
            <label for="pub_date" class="block text-sm font-medium text-primary"> Publication Date </label>
            <input
              type="date"
              id="pub_date"
              name="pub_date"
              value={post.pub_date}
              class="w-full px-4 py-3 border rounded-sm text-primary focus:outline-none focus:ring-2 focus:ring-ring"
            />
          </div>

          <!-- Tags -->
          <div class="space-y-2">
            <label for="tags" class="block text-sm font-medium text-primary"> Tags </label>
            <input
              type="text"
              id="tags"
              name="tags"
              placeholder="design, development, astro"
              value={post.tags ? post.tags.join(', ') : ''}
              class="w-full px-4 py-3 border rounded-sm text-primary placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
            />
            <p class="text-xs text-muted-foreground">Separate tags with commas</p>
          </div>

          <!-- Content Editor -->
          <div class="space-y-2">
            <label for="content" class="block text-sm font-medium text-primary"> Content* </label>

            <!-- Tiptap Editor Container -->
            <div class="tiptap-editor-container">
              <!-- Toolbar -->
              <div class="tiptap-toolbar">
                <button type="button" id="bold-btn" class="toolbar-btn">
                  <strong>B</strong>
                </button>
                <button type="button" id="italic-btn" class="toolbar-btn">
                  <em>I</em>
                </button>
                <button type="button" id="code-btn" class="toolbar-btn"> &lt;/&gt; </button>
                <button type="button" id="h1-btn" class="toolbar-btn"> H1 </button>
                <button type="button" id="h2-btn" class="toolbar-btn"> H2 </button>
                <button type="button" id="h3-btn" class="toolbar-btn"> H3 </button>
                <button type="button" id="bullet-list-btn" class="toolbar-btn"> • </button>
                <button type="button" id="ordered-list-btn" class="toolbar-btn"> 1. </button>
                <button type="button" id="blockquote-btn" class="toolbar-btn"> " </button>
                <button type="button" id="undo-btn" class="toolbar-btn"> ↶ </button>
                <button type="button" id="redo-btn" class="toolbar-btn"> ↷ </button>
              </div>

              <!-- Editor -->
              <div id="tiptap-editor" class="tiptap-editor"></div>
            </div>

            <!-- Hidden textarea for form submission -->
            <textarea id="content" name="content" class="hidden" required>{post.content}</textarea>
          </div>

          <!-- Actions -->
          <div class="flex gap-4 pt-8">
            <Button type="submit" text="Update Post" />
            <Button href={`/posts/${post.slug}`} text="Cancel" />
          </div>
        </form>

        <!-- Status Message -->
        <div id="status-message" class="mt-8"></div>
      </div>
    </main>
  </div>
</Layout>

<style>
  .tiptap-editor {
    font-family: 'Inter', sans-serif;
  }

  .tiptap-editor h1 {
    font-size: 2rem;
    font-weight: bold;
  }

  .tiptap-editor p {
    margin: 0.75em 0;
  }

  .tiptap-editor ul {
    list-style: disc;
    padding-left: 1.5rem;
  }

  .tiptap-editor blockquote {
    border-left: 4px solid #ccc;
    padding-left: 1rem;
    color: #666;
    font-style: italic;
  }

  .toolbar-btn {
    padding: 0.5rem 0.75rem;
    border: 1px solid transparent;
    background: #f3f4f6;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .toolbar-btn:hover {
    background: #e5e7eb;
  }

  .toolbar-btn.active {
    background: #d1d5db;
    font-weight: bold;
  }
</style>

<script>
  let editor;

  document.addEventListener('DOMContentLoaded', async () => {
    const editorElement = document.getElementById('tiptap-editor');
    const contentTextarea = document.getElementById('content');

    if (editorElement && contentTextarea) {
      // Dynamically import modules
      const {Editor} = await import('@tiptap/core');
      const StarterKit = await import('@tiptap/starter-kit');
      const Typography = await import('@tiptap/extension-typography');
      const Placeholder = await import('@tiptap/extension-placeholder');
      const {marked} = await import('marked');
      const TurndownService = await import('turndown');

      // Configure markdown parser
      marked.setOptions({
        breaks: true,
        gfm: true,
      });

      // Configure HTML to Markdown converter
      const turndownService = new TurndownService.default({
        headingStyle: 'atx',
        codeBlockStyle: 'fenced',
        bulletListMarker: '-',
      });

      // Convert markdown content to HTML for editor initialization
      const markdownContent = (contentTextarea as HTMLTextAreaElement).value;
      const htmlContent = await marked(markdownContent);

      // Initialize Tiptap editor
      editor = new Editor({
        element: editorElement,
        extensions: [
          StarterKit.default.configure({
            heading: {
              levels: [1, 2, 3, 4, 5, 6],
            },
            bulletList: {
              keepMarks: true,
              keepAttributes: false,
            },
            orderedList: {
              keepMarks: true,
              keepAttributes: false,
            },
          }),
          Typography.default,
          Placeholder.default.configure({
            placeholder: 'Write your post content...',
          }),
        ],
        content: htmlContent,
        editorProps: {
          attributes: {
            class: 'prose prose-lg prose-invert max-w-none focus:outline-none min-h-[400px] px-4 py-3',
          },
        },
        onUpdate: ({editor}) => {
          // Convert HTML to Markdown using turndown
          const html = editor.getHTML();
          const markdown = turndownService.turndown(html);
          (contentTextarea as HTMLTextAreaElement).value = markdown;
        },
      });

      // Toolbar button handlers
      document.getElementById('bold-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleBold().run();
      });

      document.getElementById('italic-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleItalic().run();
      });

      document.getElementById('code-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleCode().run();
      });

      document.getElementById('h1-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleHeading({level: 1}).run();
      });

      document.getElementById('h2-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleHeading({level: 2}).run();
      });

      document.getElementById('h3-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleHeading({level: 3}).run();
      });

      document.getElementById('bullet-list-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleBulletList().run();
      });

      document.getElementById('ordered-list-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleOrderedList().run();
      });

      document.getElementById('blockquote-btn')?.addEventListener('click', () => {
        editor.chain().focus().toggleBlockquote().run();
      });

      document.getElementById('undo-btn')?.addEventListener('click', () => {
        editor.chain().focus().undo().run();
      });

      document.getElementById('redo-btn')?.addEventListener('click', () => {
        editor.chain().focus().redo().run();
      });
    }
  });

  document.getElementById('edit-post-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    const formData = new FormData(form);
    const postId = (document.getElementById('post-id') as HTMLInputElement).value;

    // Make sure content is up to date from Tiptap editor
    if (editor) {
      const contentTextarea = document.getElementById('content') as HTMLTextAreaElement;
      if (contentTextarea) {
        formData.set('content', contentTextarea.value);
      }
    }

    // Convert form data to object
    const postData = {
      title: formData.get('title') as string,
      author: formData.get('author') as string,
      description: (formData.get('description') as string) || undefined,
      pub_date: (formData.get('pub_date') as string) || undefined,
      tags: ((formData.get('tags') as string) || '')
        .split(',')
        .map((tag) => tag.trim())
        .filter((tag) => tag.length > 0),
      content: formData.get('content') as string,
    };

    const statusEl = document.getElementById('status-message');

    try {
      statusEl!.innerHTML = '<div class="text-muted-foreground">Updating post...</div>';

      const response = await fetch(`/api/posts/${postId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(postData),
      });

      const result = await response.json();

      if (response.ok) {
        statusEl!.innerHTML = '<div class="text-primary">Post updated successfully!</div>';

        // Redirect to the updated post after a short delay
        setTimeout(() => {
          window.location.href = `/posts/${result.slug}`;
        }, 1500);
      } else {
        statusEl!.innerHTML = `<div class="text-destructive">Error: ${result.error}</div>`;
      }
    } catch (error) {
      statusEl!.innerHTML = '<div class="text-destructive">Failed to update post. Please try again.</div>';
      console.error('Error updating post:', error);
    }

    document.getElementById('bold-btn')?.addEventListener('click', () => {
      editor.chain().focus().toggleBold().run();
      updateToolbarState();
    });

    function updateToolbarState() {
      document.getElementById('bold-btn')?.classList.toggle('active', editor.isActive('bold'));
      document.getElementById('italic-btn')?.classList.toggle('active', editor.isActive('italic'));
      // ...etc.
    }
  });
</script>
